---
layout: default
title: linux iptables
author: lijiaocn
createdate: 2014/04/16 10:16:55
changedate: 2017/03/27 16:50:45
categories:
tags: 手册
keywords:  linux iptables
description: linux iptables

---

* auto-gen TOC:
{:toc}

iptables是linux自带的防火墙，这里做系统的介绍。

## 概览

iptables的规则按照“表(table)->规则链(chain)->规则(rule)”的层次组织。总共有五张表:

	filter
	nat
	mangle
	raw
	security

系统中依据报文的路径，设置了五个固定的检查点:

	              INPUT                 OUPUT
	                .                     |
	               /_\           +--------+
	                |           _|_
	                +--------+  \ /
	                         |   ' 
	                         Router --------|> FORWARD
	                         .   |                |
	                        /_\  +--------+       |
	                         |           _|_     _|_
	               +---------+           \ /     \ /
	               |                      '       ' 
	    PKT ---> PREROUTING              POSTROUTING  ---> PKT

这五个转发点，对应了五个固定的规则链(Chain):

	Chain PREROUTING
	Chain INPUT
	Chain OUTPUT
	Chain FORWARD
	Chain POSTROUTING

并不是每张表都包含了所有的五个Chain，五张表的用途不同，它们只包含了需要包含的Chain。

	filter: 
		Chain INPUT
		Chain FORWARD
		Chain OUTPUT

	nat:
		Chain PREROUTING
		Chain INPUT
		Chain OUTPUT
		Chain POSTROUTING

	mangle:
		Chain PREROUTING
		Chain INPUT
		Chain FORWARD
		Chain OUTPUT
		Chain POSTROUTING

	raw:
		Chain PREROUTING
		Chain OUTPUT

	security:
		Chain INPUT
		Chain FORWARD
		Chain OUTPUT

除了上述的5个固定的Chain，也可以自定义Chain，但只有通过上述5个Chain中设置的跳转规则，跳转到自定义的dChain，自定义的Chain才可以发生作用。

可以通过下面的命令查看规则:

	//查看fitler表中的所有chain
	iptables -t filter -L

	//查看fitler表中input chain中的所有规则
	iptables -t filter -L INPUT

如果不指定table，默认查看的是filter表。

## iptables表之间的关系

报文在匹配iptables的规则的时候，是按照固定的顺序进行的，既不是按照表的顺序执行，也不是按照检查点的顺序执行。

[structure-of-iptables][2]中做了非常详细的说明。

进入主机的报文:

	raw.PREROUTING -> mangle.PREROUTING -> nat.PREROUTING -> mangle.INPUT -> filter.INPUT 

主机发出的报文:

	raw.OUTPUT -> mangle.OUTPUT -> nat.OUTPUT -> filter.OUTPUT -> mangle.POSTROUTING -> nat.POSTROUTING

经主机转发的报文:

	raw.PREROUTING -> mangle.PREROUTING -> mangle.FORWARD -> filter.FORWARD -> mangle.POSTROUTING -> nat.POSTROUTING

### filter表

IPtables使用的默认表，包含三个检查点

	INPUT
	FORWARD
	OUTPUT:

### nat表

nat表，当遇到一个需要建立新连接的报文时，使用该表

	PREROUTING
	OUTPUT
	POSTROUTING

### mangle表

mangle表用于修改特定的报文

	PREROUTING
	OUTPUT
	INPUT

### raw表

raw表用于配置连接跟踪的例外情况

	PREROUTING
	OUTPUT

### security表

waiting

## 使用iptables做通信数据劫持

被劫持机:

	ip: 192.168.1.10
	netmask: 255.255.255.0
	gateway: 192.168.1.1

劫持机有两个网卡eth0和eth1

	eth0:  内网口, 接入被劫持机
		ip: 192.168.1.1
		netmask: 255.255.255.0
	
	eth1:  外网口, 接入外网
		ip: 172.19.1.10
		netmask: 255.255.255.0
		gateway: 172.19.1.1
		dns: 172.19.1.1

在劫持机上配置规则:

	eth1发出的源IP为192.168.1.10的包，源地址被改写为172.19.1.10
		iptables -t nat -A POSTROUTING -o eth1 -s 192.168.1.10 -j SNAT --to 172.19.1.10

	eth1接收的目的地址为172.19.1.10的包，目的地址被改写为192.168.1.10
		iptables -t nat -A PREROUTING -i eth1 -d 172.19.1.10 -j DNAT --to 192.168.1.10

## 文献

1. man iptables
2. [sturcture of iptables][2]

[2]: http://www.iptables.info/en/structure-of-iptables.html "structure-of-iptables"
